<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D FPS — Immediate Start (Three.js) — Working Build</title>
  <style>
    html,body{height:100%;margin:0;background:#081926;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial}
    #container{width:100%;height:100%}
    .overlay{position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none}
    .crosshair{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background:#fff;pointer-events:none;z-index:20}
    .hud{position:fixed;left:12px;bottom:12px;color:#fff;font-size:13px;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:6px;z-index:30}
    .message{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:31;color:#fff;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:6px}
    .centerBtn{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:31;padding:10px 14px;border-radius:8px;background:#1b6;cursor:pointer;color:#001}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div id="container"></div>
  <div class="overlay"><div class="crosshair"></div></div>
  <div class="hud" id="hud">Weapon: <strong id="weaponName">AK-47</strong> • Ammo: <span id="ammo">30</span>/<span id="reserve">90</span></div>
  <div class="message" id="info">Click canvas to lock pointer, or drag mouse to look. WASD move, LMB fire, 1/2/3 switch, R reload.</div>
  <div class="centerBtn small" id="startBtn">Click to start (required for pointer lock on some browsers)</div>

  <!-- non-module Three.js and PointerLockControls (non-module build) -->
  <script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.154.0/examples/js/controls/PointerLockControls.js"></script>

  <script>
  (function(){
    // --- Safety / quick fail message ---
    const startBtn = document.getElementById('startBtn');
    const info = document.getElementById('info');
    function showError(msg){ info.textContent = msg; startBtn.style.display='block'; }

    if(typeof THREE === 'undefined'){ showError('Three.js failed to load — check network or CDN.'); return; }

    // --- Scene / Camera / Renderer ---
    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87c3ff);
    scene.fog = new THREE.Fog(0x87c3ff, 10, 300);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.05, 1000);
    camera.position.set(0, 1.6, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    // --- Lighting ---
    const hemi = new THREE.HemisphereLight(0xddeeff, 0x444455, 0.9); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(10,20,10); dir.castShadow=true; scene.add(dir);
    const rim = new THREE.PointLight(0xffe6c7, 0.35, 40); rim.position.set(-5,3,-5); scene.add(rim);

    // --- Floor and environment ---
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(400,400), new THREE.MeshStandardMaterial({ color:0x556b2f, roughness:0.95 }));
    floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

    const crateGeo = new THREE.BoxGeometry(1.4,1.4,1.4);
    for(let i=0;i<18;i++){
      const mat = new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(0.03 + Math.random()*0.08, 0.6, 0.25), roughness:0.7 });
      const crate = new THREE.Mesh(crateGeo, mat);
      crate.position.set((Math.random()-0.5)*60, 0.7, (Math.random()*-60)-5);
      crate.castShadow = true; crate.receiveShadow = true; scene.add(crate);
    }

    // --- Hands and weapons attached to camera ---
    const hands = new THREE.Group(); camera.add(hands); hands.position.set(0, -0.25, -0.45);
    function makeHand(){ const g = new THREE.Group(); const palm = new THREE.Mesh(new THREE.BoxGeometry(0.22,0.08,0.25), new THREE.MeshStandardMaterial({ color:0xffd1a4, roughness:0.7 })); palm.position.set(0,-0.05,-0.12); g.add(palm); return g; }
    const leftHand = makeHand(); const rightHand = makeHand(); leftHand.position.x = -0.12; rightHand.position.x = 0.12; hands.add(leftHand); hands.add(rightHand);

    function makeAK(){ const g=new THREE.Group(); const body=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.12,0.12), new THREE.MeshStandardMaterial({ color:0x212121, roughness:0.4, metalness:0.25 })); body.position.set(0.12,-0.02,0); g.add(body); const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.9,10), new THREE.MeshStandardMaterial({ color:0x0b0b0b, metalness:0.95 })); barrel.rotation.z=Math.PI/2; barrel.position.set(0.7,-0.02,0); g.add(barrel); const stock=new THREE.Mesh(new THREE.BoxGeometry(0.32,0.1,0.12), new THREE.MeshStandardMaterial({ color:0x3b2a22 })); stock.position.set(-0.6,0,-0.02); g.add(stock); g.userData={anim:{recoil:0}}; g.name='AK-47'; g.scale.set(0.9,0.9,0.9); return g; }
    function makeGlock(){ const g=new THREE.Group(); const slide=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.08,0.12), new THREE.MeshStandardMaterial({ color:0x333333, roughness:0.4 })); slide.position.set(0.15,-0.02,0); g.add(slide); const grip=new THREE.Mesh(new THREE.BoxGeometry(0.12,0.32,0.08), new THREE.MeshStandardMaterial({ color:0x111111 })); grip.position.set(-0.12,-0.18,0); grip.rotation.z=-0.06; g.add(grip); const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.35,8), new THREE.MeshStandardMaterial({ color:0x111111 })); barrel.rotation.z=Math.PI/2; barrel.position.set(0.4,-0.02,0); g.add(barrel); g.userData={anim:{recoil:0}}; g.name='Glock 19'; return g; }
    function makeKnife(){ const g=new THREE.Group(); const blade=new THREE.Mesh(new THREE.BoxGeometry(0.02,0.3,0.02), new THREE.MeshStandardMaterial({ color:0xc0c0c0, metalness:0.9 })); blade.position.set(0.25,-0.05,0); blade.rotation.z=0.25; g.add(blade); const handle=new THREE.Mesh(new THREE.BoxGeometry(0.05,0.09,0.05), new THREE.MeshStandardMaterial({ color:0x221711 })); handle.position.set(-0.02,-0.12,0); g.add(handle); g.userData={anim:{swing:0}}; g.name='Knife'; g.scale.set(1.6,1.6,1.6); return g; }

    const weapons = [ makeAK(), makeGlock(), makeKnife() ]; weapons.forEach(w=>{ w.position.set(0.25,-0.12,-0.2); w.rotation.set(-0.15,0.2,0); w.visible=false; hands.add(w); }); let active = 0; weapons[active].visible = true;

    const weaponData = [ {name:'AK-47', ammo:30, mag:30, reserve:90, rate:0.095}, {name:'Glock 19', ammo:15, mag:15, reserve:45, rate:0.14}, {name:'Knife', ammo:1, mag:1, reserve:0, rate:0.45} ];
    const hudWeaponName = document.getElementById('weaponName'); const hudAmmo = document.getElementById('ammo'); const hudReserve = document.getElementById('reserve');
    function updateHUD(){ hudWeaponName.textContent = weaponData[active].name; hudAmmo.textContent = weaponData[active].ammo; hudReserve.textContent = weaponData[active].reserve; }
    updateHUD();

    // --- Raycaster, muzzle flash particles ---
    const raycaster = new THREE.Raycaster(); let lastShot = 0;
    function spawnMuzzleFlash(pos){ const geom = new THREE.PlaneGeometry(0.18,0.12); const mat = new THREE.MeshBasicMaterial({ color:0xfff0b6, transparent:true, opacity:0.95, blending:THREE.AdditiveBlending }); const mesh = new THREE.Mesh(geom, mat); mesh.position.copy(pos); mesh.lookAt(camera.position); scene.add(mesh); setTimeout(()=>{ try{ scene.remove(mesh); }catch(e){} }, 60);
      // simple sparks
      for(let i=0;i<8;i++){ const s = new THREE.Mesh(new THREE.SphereGeometry(0.01,6,6), new THREE.MeshBasicMaterial({ color:0xffb86b })); s.position.copy(pos); s.velocity = new THREE.Vector3((Math.random()-0.5)*0.6, Math.random()*0.7, (Math.random()-0.5)*0.6); scene.add(s); (function start(t0){ const fn = (t)=>{ const tt = (t - t0)/1000; s.position.addScaledVector(s.velocity, 0.016); s.velocity.y -= 1.2*0.016; s.material.opacity = Math.max(0, 1 - tt*1.5); if(tt < 0.7) requestAnimationFrame(fn); else try{ scene.remove(s); }catch(e){} }; requestAnimationFrame(fn); })(performance.now()); }
    }

    function fire(){ const now = performance.now()/1000; const w = weaponData[active]; if(now - lastShot < w.rate) return; if(w.ammo <= 0) return; lastShot = now; w.ammo = Math.max(0, w.ammo - 1); updateHUD(); const weaponMesh = weapons[active]; if(weaponMesh.userData.anim) weaponMesh.userData.anim.recoil = 1.0; const origin = camera.getWorldPosition(new THREE.Vector3()); const dir = new THREE.Vector3(); camera.getWorldDirection(dir); raycaster.set(origin, dir);
      const hits = raycaster.intersectObjects(scene.children, true).filter(i=> !weapons.includes(i.object) && i.object !== leftHand && i.object !== rightHand && i.object !== floor);
      if(hits.length>0){ const h = hits[0].object; if(h.material && h.material.color) h.material.color.offsetHSL(0, -0.05, -0.04); }
      // muzzle flash
      const muzzleLocal = new THREE.Vector3(0.95, 0, 0); const muzzleWorld = weaponMesh.localToWorld(muzzleLocal.clone()); spawnMuzzleFlash(muzzleWorld);
    }

    // --- Input ---
    window.addEventListener('mousedown', (e)=>{ if(e.button === 0) fire(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === '1') switchWeapon(0); if(e.key === '2') switchWeapon(1); if(e.key === '3') switchWeapon(2); if(e.key.toLowerCase() === 'r') reload(); });
    function reload(){ const w = weaponData[active]; if(w.reserve <= 0) return; const need = w.mag - w.ammo; const take = Math.min(need, w.reserve); w.ammo += take; w.reserve -= take; updateHUD(); }
    function switchWeapon(i){ if(i === active) return; weapons[active].visible = false; active = i; weapons[active].visible = true; updateHUD(); }

    // Movement & look
    const move = { f:false, b:false, l:false, r:false };
    window.addEventListener('keydown', e=>{ if(e.code === 'KeyW') move.f = true; if(e.code === 'KeyS') move.b = true; if(e.code === 'KeyA') move.l = true; if(e.code === 'KeyD') move.r = true; });
    window.addEventListener('keyup', e=>{ if(e.code === 'KeyW') move.f = false; if(e.code === 'KeyS') move.b = false; if(e.code === 'KeyA') move.l = false; if(e.code === 'KeyD') move.r = false; });

    let dragging = false; let prev = { x:0, y:0 }; let yaw = 0, pitch = 0;
    renderer.domElement.addEventListener('mousedown', (e)=>{ dragging = true; prev.x = e.clientX; prev.y = e.clientY; });
    window.addEventListener('mouseup', ()=>{ dragging = false; });
    window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx = e.clientX - prev.x; const dy = e.clientY - prev.y; prev.x = e.clientX; prev.y = e.clientY; const sens = 0.0025; yaw -= dx * sens; pitch -= dy * sens; pitch = Math.max(-Math.PI/2 + 0.01, Math.min(Math.PI/2 - 0.01, pitch)); camera.rotation.order = 'YXZ'; camera.rotation.y = yaw; camera.rotation.x = pitch; });

    // PointerLockControls (optional) — non-module build assigns to THREE.PointerLockControls
    let plControls = null;
    if(window.THREE && THREE.PointerLockControls){ try{ plControls = new THREE.PointerLockControls(camera, renderer.domElement); document.addEventListener('click', ()=>{ if(document.pointerLockElement !== renderer.domElement) plControls.lock(); }); plControls.addEventListener('lock', ()=>{ startBtn.style.display = 'none'; info.textContent = 'Pointer locked — play!'; }); plControls.addEventListener('unlock', ()=>{ info.textContent = 'Pointer unlocked — click to lock again or drag to look.'; startBtn.style.display = 'block'; }); }catch(e){ console.warn('PointerLockControls not available', e); } }

    // start button requests a user gesture (required in some browsers to allow pointer lock/audio)
    startBtn.addEventListener('click', ()=>{ try{ renderer.domElement.focus(); if(plControls) plControls.lock(); startBtn.style.display='none'; info.textContent = 'Playing — click to toggle pointer lock'; }catch(e){ console.warn(e); } });

    // --- Render loop ---
    let prevT = performance.now();
    function loop(){ const now = performance.now(); const dt = Math.min((now - prevT)/1000, 0.05); prevT = now;
      // movement
      const speed = 5;
      const forward = new THREE.Vector3(); camera.getWorldDirection(forward); forward.y = 0; forward.normalize(); const right = new THREE.Vector3().crossVectors(camera.up, forward).normalize();
      if(move.f) camera.position.addScaledVector(forward, -speed * dt);
      if(move.b) camera.position.addScaledVector(forward, speed * dt);
      if(move.l) camera.position.addScaledVector(right, -speed * dt);
      if(move.r) camera.position.addScaledVector(right, speed * dt);

      // hands bobbing
      hands.position.y = -0.25 + Math.sin(now/200) * 0.006;

      // weapon anims
      weapons.forEach(w=>{
        if(w.userData.anim){
          for(const k in w.userData.anim) w.userData.anim[k] = Math.max(0, w.userData.anim[k] - dt * 6);
          const r = (w.userData.anim.recoil || 0) * 0.035;
          w.position.z = -0.2 - r;
          w.position.y = -0.12;
          w.rotation.x = -0.15 - (w.userData.anim.recoil || 0) * 0.08;
        }
      });

      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // hide start button after a short delay if not needed
    setTimeout(()=>{ startBtn.style.display='none'; }, 3000);

    // resize
    window.addEventListener('resize', ()=>{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

    // final log
    console.log('Working FPS demo loaded. If you see a black screen: open DevTools (F12) → Console and paste errors here.');
  })();
  </script>
</body>
</html>
